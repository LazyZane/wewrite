# WeWrite å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ä¿®å¤æ—¥å¿—

## ğŸ“… ä¿®å¤æ—¶é—´
2025-01-11

## ğŸš¨ é—®é¢˜æè¿°

### åŸå§‹é—®é¢˜
ç”¨æˆ·åé¦ˆå›¾åºŠé“¾æ¥ï¼ˆå¦‚ `http://lsky.xinqi.life:2052/up/2025/07/08/686c6f15515ef.png`ï¼‰åœ¨å‘é€åˆ°å¾®ä¿¡å…¬ä¼—å·è‰ç¨¿ç®±æ—¶ï¼Œæ²¡æœ‰è¢«ä¸‹è½½å¹¶é‡æ–°ä¸Šä¼ åˆ°å¾®ä¿¡CDNï¼Œè€Œæ˜¯ç›´æ¥ä¼ é€’äº†åŸå§‹é“¾æ¥ï¼Œå¯¼è‡´å¾®ä¿¡å…¬ä¼—å·æ— æ³•æ­£å¸¸æ˜¾ç¤ºå›¾ç‰‡ã€‚

### é”™è¯¯ç°è±¡
1. **å‘é€åˆ°è‰ç¨¿ç®±**ï¼šå›¾ç‰‡ä½ç½®æ˜¾ç¤ºä¸ºç©ºç™½
2. **å¤åˆ¶åˆ°å¾®ä¿¡ç¼–è¾‘å™¨**ï¼šä»ç„¶æ˜¯åŸå§‹URLï¼Œä¸Šä¼ å¤±è´¥
3. **å¾®ä¿¡æ˜¾ç¤º**ï¼š"å›¾ç‰‡è½½å…¥å¤±è´¥ï¼Œæ¥æºé“¾æ¥ http://lsk...c2a.pngï¼Œæ‹‰å–å›¾ç‰‡æ•°æ®å¤±è´¥"

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
é€šè¿‡è¯¦ç»†çš„æ—¥å¿—åˆ†æï¼Œå‘ç°äº†ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š

1. **Promiseå¤„ç†é”™è¯¯**ï¼š`fetchImageBlob()` å‡½æ•°ä¸­çš„é”™è¯¯å¤„ç†ä¸å½“ï¼Œå¯¼è‡´Promiseæ°¸è¿œä¸ä¼šå®Œæˆ
2. **é™é»˜å¤±è´¥**ï¼šå›¾ç‰‡ä¸‹è½½å¤±è´¥æ—¶é™é»˜è·³è¿‡ï¼Œä¸æ›¿æ¢å›¾ç‰‡src
3. **æ–‡ä»¶ç±»å‹æ£€æµ‹é”™è¯¯**ï¼šå¾®ä¿¡APIè¿”å›é”™è¯¯ç  `40005 invalid file type hint`ï¼Œå› ä¸ºç”Ÿæˆçš„æ–‡ä»¶åç¼ºå°‘æ­£ç¡®çš„æ‰©å±•å

### æŠ€æœ¯ç»†èŠ‚
- **é”™è¯¯ç 40005**ï¼šå¾®ä¿¡APIæ— æ³•è¯†åˆ«æ–‡ä»¶ç±»å‹
- **Blobç±»å‹ä¸ºç©º**ï¼šä¸‹è½½çš„å›¾ç‰‡blobæ²¡æœ‰æ­£ç¡®çš„MIMEç±»å‹
- **æ–‡ä»¶åé”™è¯¯**ï¼šç”Ÿæˆçš„æ–‡ä»¶åç±»ä¼¼ `image-xxx.undefined`

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤Promiseå¤„ç† (`src/utils/utils.ts`)

**ä¿®å¤å‰**ï¼š
```typescript
if (!url) {
    console.error(`Invalid URL: ${url}`);
    return; // âŒ æ²¡æœ‰rejectï¼ŒPromiseæ°¸è¿œä¸ä¼šå®Œæˆ
}
```

**ä¿®å¤å**ï¼š
```typescript
if (!url) {
    console.error(`[WeWrite] Invalid URL: ${url}`);
    reject(new Error(`Invalid URL: ${url}`));
    return;
}
```

### 2. ä¿®å¤MIMEç±»å‹æ£€æµ‹ (`src/utils/utils.ts`)

**æ–°å¢åŠŸèƒ½**ï¼š
```typescript
// å°è¯•ä»å“åº”å¤´è·å–Content-Type
let contentType = 'image/jpeg'; // é»˜è®¤ç±»å‹
if (response.headers && response.headers['content-type']) {
    contentType = response.headers['content-type'];
} else {
    // å°è¯•ä»URLæ‰©å±•åæ¨æ–­ç±»å‹
    const urlLower = url.toLowerCase();
    if (urlLower.includes('.png')) {
        contentType = 'image/png';
    } else if (urlLower.includes('.gif')) {
        contentType = 'image/gif';
    }
    // ... æ›´å¤šç±»å‹
}

const blob = new Blob([response.arrayBuffer], { type: contentType });
```

### 3. æ”¹è¿›æ–‡ä»¶åç”Ÿæˆ (`src/render/post-render.ts`)

**ä¿®å¤å‰**ï¼š
```typescript
function imageFileName(mime:string){
    const type = mime.split('/')[1]
    return `image-${new Date().getTime()}.${type}`
}
```

**ä¿®å¤å**ï¼š
```typescript
function imageFileName(mime:string){
    // å¦‚æœmimeä¸ºç©ºæˆ–æ— æ•ˆï¼Œé»˜è®¤ä½¿ç”¨jpg
    if (!mime || mime === '' || !mime.includes('/')) {
        return `image-${new Date().getTime()}.jpg`;
    }
    
    const parts = mime.split('/');
    if (parts.length < 2) {
        return `image-${new Date().getTime()}.jpg`;
    }
    
    let type = parts[1];
    
    // å¤„ç†å¸¸è§çš„mimeç±»å‹æ˜ å°„
    const mimeMap: {[key: string]: string} = {
        'jpeg': 'jpg',
        'png': 'png',
        'gif': 'gif',
        'webp': 'webp',
        'bmp': 'bmp',
        'svg+xml': 'svg'
    };
    
    const extension = mimeMap[type] || 'jpg';
    return `image-${new Date().getTime()}.${extension}`;
}
```

### 4. æ”¹è¿›é”™è¯¯å¤„ç† (`src/wechat-api/wechat-client.ts`)

**ä¿®å¤å†…å®¹**ï¼š
- ä¸å†æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯è¿”å›é”™è¯¯ä¿¡æ¯
- ä¿ç•™å…³é”®é”™è¯¯æ—¥å¿—ï¼Œç§»é™¤å†—ä½™è°ƒè¯•ä¿¡æ¯
- ç¡®ä¿æ€»æ˜¯è¿”å›æ ‡å‡†æ ¼å¼çš„ç»“æœå¯¹è±¡

### 5. ä¼˜åŒ–ä¸Šä¼ æµç¨‹ (`src/render/post-render.ts`)

**æ”¹è¿›å†…å®¹**ï¼š
- ç®€åŒ–æ—¥å¿—è¾“å‡ºï¼Œä¿ç•™å…³é”®é”™è¯¯ä¿¡æ¯
- æ”¹è¿›é”™è¯¯å¤„ç†é€»è¾‘
- æ·»åŠ åŸå§‹é“¾æ¥è®°å½•åŠŸèƒ½

## âœ… ä¿®å¤ç»“æœ

### ä¿®å¤åçš„å·¥ä½œæµç¨‹
1. **å›¾ç‰‡è¯†åˆ«**ï¼šæ­£ç¡®è¯†åˆ«å¤–éƒ¨å›¾åºŠé“¾æ¥
2. **å›¾ç‰‡ä¸‹è½½**ï¼šæˆåŠŸä¸‹è½½å¹¶è®¾ç½®æ­£ç¡®çš„MIMEç±»å‹
3. **æ–‡ä»¶åç”Ÿæˆ**ï¼šç”Ÿæˆå¸¦æœ‰æ­£ç¡®æ‰©å±•åçš„æ–‡ä»¶åï¼ˆå¦‚ `image-1736604123456.png`ï¼‰
4. **å¾®ä¿¡ä¸Šä¼ **ï¼šæˆåŠŸä¸Šä¼ åˆ°å¾®ä¿¡CDN
5. **é“¾æ¥æ›¿æ¢**ï¼šå°†åŸå§‹é“¾æ¥æ›¿æ¢ä¸ºå¾®ä¿¡CDNé“¾æ¥

### æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
- **JPEG/JPG**ï¼š`image/jpeg` â†’ `.jpg`
- **PNG**ï¼š`image/png` â†’ `.png`
- **GIF**ï¼š`image/gif` â†’ `.gif`
- **WebP**ï¼š`image/webp` â†’ `.webp`
- **BMP**ï¼š`image/bmp` â†’ `.bmp`
- **SVG**ï¼š`image/svg+xml` â†’ `.svg`

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹
1. **å›¾åºŠé“¾æ¥**ï¼š`http://lsky.xinqi.life:2052/up/2025/07/08/686c6f15515ef.png`
2. **å¾®ä¿¡å›¾åºŠ**ï¼š`https://mmbiz.qpic.cn/mmbiz_png/xxx.png`ï¼ˆåº”è·³è¿‡ï¼‰
3. **Base64å›¾ç‰‡**ï¼š`data:image/png;base64,xxx`
4. **æœ¬åœ°å›¾ç‰‡**ï¼šObsidianå†…éƒ¨å›¾ç‰‡

### é¢„æœŸç»“æœ
- å¤–éƒ¨å›¾åºŠé“¾æ¥æˆåŠŸä¸Šä¼ å¹¶æ›¿æ¢ä¸ºå¾®ä¿¡CDNé“¾æ¥
- å¾®ä¿¡å›¾åºŠé“¾æ¥ä¿æŒä¸å˜
- Base64å’Œæœ¬åœ°å›¾ç‰‡æ­£å¸¸å¤„ç†

## ğŸ“‹ åç»­ä¼˜åŒ–è®¡åˆ’

### çŸ­æœŸä¼˜åŒ–
1. **ç”¨æˆ·åé¦ˆ**ï¼šæ·»åŠ ä¸Šä¼ è¿›åº¦æç¤º
2. **é”™è¯¯æç¤º**ï¼šä¸ºç”¨æˆ·æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
3. **é‡è¯•æœºåˆ¶**ï¼šå¯¹å¤±è´¥çš„ä¸Šä¼ è¿›è¡Œè‡ªåŠ¨é‡è¯•

### é•¿æœŸä¼˜åŒ–
1. **æ‰¹é‡ä¸Šä¼ **ï¼šä¼˜åŒ–å¤šå›¾ç‰‡ä¸Šä¼ æ€§èƒ½
2. **ç¼“å­˜æœºåˆ¶**ï¼šé¿å…é‡å¤ä¸Šä¼ ç›¸åŒå›¾ç‰‡
3. **æ ¼å¼è½¬æ¢**ï¼šè‡ªåŠ¨è½¬æ¢ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼

## ğŸ”§ ç»´æŠ¤è¯´æ˜

### å…³é”®æ–‡ä»¶
- `src/utils/utils.ts`ï¼šå›¾ç‰‡ä¸‹è½½å’Œç±»å‹æ£€æµ‹
- `src/render/post-render.ts`ï¼šå›¾ç‰‡ä¸Šä¼ å¤„ç†å’Œæ–‡ä»¶åç”Ÿæˆ
- `src/wechat-api/wechat-client.ts`ï¼šå¾®ä¿¡APIè°ƒç”¨
- `src/views/previewer.ts`ï¼šå‘é€æµç¨‹æ§åˆ¶

### è°ƒè¯•æ–¹æ³•
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
2. æŸ¥çœ‹Consoleæ ‡ç­¾çš„ `[WeWrite]` æ—¥å¿—
3. å…³æ³¨é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯
4. æ£€æŸ¥å›¾ç‰‡srcæ˜¯å¦è¢«æ­£ç¡®æ›¿æ¢

### å¸¸è§é—®é¢˜æ’æŸ¥
- **é”™è¯¯ç 40005**ï¼šæ£€æŸ¥æ–‡ä»¶åå’ŒMIMEç±»å‹
- **ä¸‹è½½å¤±è´¥**ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥å’Œå›¾ç‰‡URLæœ‰æ•ˆæ€§
- **ä¸Šä¼ å¤±è´¥**ï¼šæ£€æŸ¥å¾®ä¿¡APIè®¿é—®ä»¤ç‰Œå’Œæƒé™

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025-01-11  
**ä¿®å¤äººå‘˜**ï¼šAI Assistant  
**ç‰ˆæœ¬**ï¼šv1.0.0
